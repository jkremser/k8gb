package controllers

import (
	"context"
	"fmt"
	"github.com/k8gb-io/k8gb/controllers/depresolver"
	"sigs.k8s.io/controller-runtime/pkg/client"
	corev1 "k8s.io/api/core/v1"
)

/*
Copyright 2021 The k8gb Contributors.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

Generated by GoLic, for more details see: https://github.com/AbsaOSS/golic
*/

func (r *GslbReconciler) PostStartHook(operatorConfig *depresolver.Config, client client.Reader) error {
	return inferClusterGeoTag(operatorConfig, client)
}

func inferClusterGeoTag(operatorConfig *depresolver.Config, client client.Reader) error {
	if len(operatorConfig.ClusterGeoTag) != 0 {
		// env var has the highest precedence
		return nil
	}
	nodeList := &corev1.NodeList{}
	err := client.List(context.TODO(), nodeList)
	if err != nil {
		return fmt.Errorf("unable to get the nodes in the cluster, error: %v", err)
	}
	if len(nodeList.Items) == 0 {
		return fmt.Errorf("no available nodes in the cluster")
	}
	// values of this annotation/label is cloud provider specific
	const region = "topology.kubernetes.io/region" // (example: africa-east-1)
	// assuming all the nodes to have the same topology.kubernetes.io/region so
	var foundTag string = ""
	for _, node := range nodeList.Items {
		switch {
		case len(node.Annotations[region]) != 0:
			foundTag = node.Annotations[region]
		case len(node.Labels[region]) != 0:
			foundTag = node.Labels[region]
		}
		if len(operatorConfig.ClusterGeoTag) != 0 && operatorConfig.ClusterGeoTag != foundTag {
			return fmt.Errorf("%v nodes were tried, but they don't have the same annotation/label on " +
				"them ('%s' != '%s'). Remedy: make sure the value of '%s' is same on each node in the cluster",
				len(nodeList.Items), operatorConfig.ClusterGeoTag, foundTag, region)
		}
		operatorConfig.ClusterGeoTag = foundTag
	}
	if len(operatorConfig.ClusterGeoTag) == 0 {
		return fmt.Errorf("%v nodes were tried, but none of them were annotated. Either set the %s explicitly" +
			" as operator conviguraion using env variable, or mark the nodes with label (or annotation) '%s'",
			len(nodeList.Items), depresolver.ClusterGeoTagKey, region)
	}
	return nil
}